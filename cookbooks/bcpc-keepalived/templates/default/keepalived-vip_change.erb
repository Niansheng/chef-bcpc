#!/bin/bash
################################################
#
#              Generated by Chef
#
################################################

# this script is invoked on VIP change events via the vip_won/vip_lost symlinks
# (so that the appropriate initctl events are emitted)
SCRIPT_NAME=$(basename $0)

# detect if network flapping is spawning multiple instances of this script
if [ "$(pgrep -c $SCRIPT_NAME)" -gt "1" ]; then
  echo "$SCRIPT_NAME already running, exiting."
  exit 0
fi

# Restart the PowerDNS service, attempt to lock doing so to avoid
# multiple copies of PowerDNS starting up (see #986)
LOCK_FILE=/tmp/powerdns_restart.lock
if [ ! -f $LOCK_FILE ]; then
  echo $$ >> $LOCK_FILE
  service pdns restart
  rm -f $LOCK_FILE
fi

# Restart local OpenStack services
/usr/local/bin/hup_openstack

# Generate an upstart event to notify anything that needs
# to take action on a vip change
initctl emit --no-wait $SCRIPT_NAME
