Listen <%= node['bcpc']['management']['ip'] %>:5000
Listen <%= node['bcpc']['management']['ip'] %>:35357

<VirtualHost <%= node['bcpc']['management']['ip'] %>:5000>
    WSGIDaemonProcess keystone-public processes=<%= @processes %> threads=<%= @threads %> user=keystone display-name=%{GROUP}
    WSGIProcessGroup keystone-public
    WSGIScriptAlias / /var/www/cgi-bin/keystone/main
    WSGIApplicationGroup %{GLOBAL}
    WSGIPassAuthorization On
    <IfVersion >= 2.4>
        ErrorLogFormat "%{cu}t %M"
    </IfVersion>
    CustomLog /var/log/apache2/keystone_access.log combined

    <%# http://docs.openstack.org/developer/keystone/federation/websso.html %>
    <% if node['bcpc']['keystone']['federation']['kerberos'] %>
    <%
        config_opts = node['bcpc']['keystone']['federation']['kerberos']
        routes = ["/v3/auth/OS-FEDERATION/websso/#{config_opts['protocol_name']}"]
        routes << "/v3/auth/OS-FEDERATION/identity_providers/#{config_opts['provider_name']}/protocols/#{config_opt['protocol_name']}"
        routes.each do |route|
    %>
    <Location ~ "<%= route %>">
        <%# KERB_ID must match the IdP set in Openstack. %>
        SetEnv KERB_ID <%= node['bcpc']['keystone']['federation']['kerberos']['remote_id'] %>

        AuthType Kerberos
        AuthName "Kerberos Login"
        KrbMethodNegotiate on
        KrbServiceName HTTP
        KrbSaveCredentials on
        KrbLocalUserMapping on
        KrbAuthRealms HYPERVISOR-BCPC.EXAMPLE.COM
        Krb5Keytab /etc/apache2/krb5.keytab
        KrbMethodK5Passwd off #optional-- if 'off' makes GSSAPI SPNEGO a requirement
        <%# Don't lock ourselves out before configuration is complete %>
        <% if not @kerberos_setup %>
        Require valid-user
        <% end %>
    </Location>
    <%  end #route.each %>
    <% end %>
</VirtualHost>

<VirtualHost <%= node['bcpc']['management']['ip'] %>:35357>
    WSGIDaemonProcess keystone-admin processes=5 threads=1 user=keystone display-name=%{GROUP}
    WSGIProcessGroup keystone-admin
    WSGIScriptAlias / /var/www/cgi-bin/keystone/admin
    WSGIApplicationGroup %{GLOBAL}
    WSGIPassAuthorization On
    <IfVersion >= 2.4>
        ErrorLogFormat "%{cu}t %M"
    </IfVersion>
    CustomLog /var/log/apache2/keystone_access.log combined
</VirtualHost>
